version: '3.8'
services:
  frontend-test:
    build: ../frontend
    ports: ["3000:80"]
    environment:
      - NODE_ENV=test
      - VITE_API_URL=http://localhost:3001/api
      - VITE_SOCKET_URL=http://localhost:3001
      - VITE_TEST_MODE=true
    depends_on: [backend-test]

  backend-test:
    build: ../backend
    ports: ["3001:3001"]
    environment:
      - NODE_ENV=test
      - DATABASE_URL=postgresql://l2p_user:l2p_password@postgres-test:5432/l2p_test
      - JWT_SECRET=test-jwt-secret-for-testing-only
      - JWT_REFRESH_SECRET=test-jwt-refresh-secret-for-testing-only
      - POSTGRES_DB=l2p_test
      - POSTGRES_USER=l2p_user
      - POSTGRES_PASSWORD=l2p_password
      - DB_SSL=false
      - LOG_LEVEL=warn
    depends_on: [postgres-test]

  postgres-test:
    image: postgres:15
    environment:
      - POSTGRES_DB=l2p_test
      - POSTGRES_USER=l2p_user
      - POSTGRES_PASSWORD=l2p_password
    ports: ["5433:5432"]
    volumes:
      - ../database/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U l2p_user -d l2p_test"]
      interval: 5s
      timeout: 5s
      retries: 5 